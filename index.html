<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crush Machine Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: #fff;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 10px;
            box-sizing: border-box;
        }

        .container {
            background-color: #0d1b2a;
            border: 2px solid #4a4a4a;
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            max-width: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: auto;
        }

        .top-panel {
            display: flex;
            justify-content: space-around;
            background-color: #1c2541;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #3a506b;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .display-box {
            background-color: #0b132b;
            padding: 10px 20px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #3a506b;
            flex: 1;
            min-width: 150px;
        }

        .display-box label {
            font-size: 0.8em;
            color: #adb5bd;
            display: block;
            margin-bottom: 5px;
        }

        .value-display {
            font-size: 2.2em;
            font-weight: bold;
            color: #ffffff;
            padding: 5px 0;
        }

        .green-text {
            color: #28a745;
        }

        .main-content {
            display: flex;
            flex-direction: row;
            gap: 10px;
            flex-grow: 1;
            min-height: 0;
        }

        .left-controls {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 0px;
            background-color: #1c2541;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3a506b;
            min-width: 0;
            overflow: hidden;
        }

        .control-buttons-major {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;

        }

        .control-button {
            width: 80px;
            height: 80px;
            border: 2px solid #555;
            border-radius: 10px;
            cursor: pointer;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }

        .control-button:active {
            transform: scale(0.95);
        }

        .control-button:hover {
            background-color: #0056b3;
        }

        .control-button svg {
            display: block;
            width: 60%;
            height: 60%;
        }

        .start-btn {
            background-color: #2a9d8f;
            border-color: #2a9d8f;
            /*margin-right: 10%;*/
        }

        .stop-btn {
            background-color: #e76f51;
            border-color: #e76f51;
        }

        .arrow-btn {
            background-color: #007bff;
            border-color: #007bff;

            svg {
                width: 100%;
                height: 100%;
            }
        }


        .graph-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #000;
            border: 1px solid #3a506b;
            border-radius: 5px;
            padding: 10px;
            min-width: 0;
            min-height: 0;
            max-height: auto;
            overflow: hidden;
        }


        .graph-header {
            color: #ccc;
            font-size: 0.9em;
            text-align: center;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        #tensile-graph {
            width: 100%;
            height: 100%;
            flex-grow: 1;
        }

        .right-panel {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #1c2541;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3a506b;
            min-height: 0;
        }

        .connect-ble-container {
            margin-bottom: 10px;
            text-align: center;
            flex-shrink: 0;
        }

        .connect-ble-button {
            background-color: #28a745;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            padding: 10px 15px;
            width: 100%;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .connect-ble-button:hover {
            background-color: #218838;
        }

        .connect-ble-button.disconnect {
            background-color: #dc3545;
        }

        .connect-ble-button.disconnect:hover {
            background-color: #c82333;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            justify-content: space-around;
            margin-bottom: 0px;
            background-color: #0b132b;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #3a506b;
            flex-shrink: 0;
        }

        .tab-button {
            flex-grow: 1;
            padding: 10px;
            background-color: #0b132b;
            color: #adb5bd;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s, color 0.2s;
        }

        .tab-button:hover {
            background-color: #1c2541;
        }

        .tab-button.active {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        /* Tab content container */
        .tab-content-container {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-grow: 1;
            min-height: 0;
            border: 1px solid #3a506b;
            border-radius: 5px;
            background-color: #0b132b;
        }

        .tab-panel {
            display: none;
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
            max-height: 100%;
        }

        .tab-panel.active {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Settings Group Styles */
        .settings-group {
            background-color: #1c2541;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #3a506b;
        }

        .settings-group h3 {
            color: #fff;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #3a506b;
            padding-bottom: 10px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .setting-item label {
            color: #adb5bd;
            font-size: 0.9em;
            flex-basis: 120px;
        }

        .setting-item input[type="number"],
        .setting-item select {
            background-color: #0b132b;
            color: #fff;
            border: 1px solid #3a506b;
            border-radius: 4px;
            padding: 8px;
            flex-grow: 1;
            width: auto;
            font-size: 1em;
        }

        .setting-item select option {
            background-color: #0b132b;
            color: #fff;
        }

        /* Action Buttons within settings groups */
        .settings-group .action-buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-top: 10px;
        }

        .settings-group .action-buttons button {
            background-color: #007bff;
            color: white;
            padding: 10px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            flex-grow: 1;
            transition: background-color 0.2s;
        }

        .settings-group .action-buttons button:hover {
            background-color: #0056b3;
        }

        .report-button-container {
            margin: 1px 10px;
            flex-shrink: 0;
        }

        .report-btn {
            background-color: #fca311;
            color: #000;
            font-weight: bold;
            font-size: 1.2em;
            padding: 10px;
            width: 100%;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .report-btn:active {
            background-color: #e89200;
            transform: translateY(1px);
        }

        .results-display {
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .result-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #1c2541;
            padding: 8px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .result-item label {
            color: #adb5bd;
            font-size: 0.9em;
            flex-basis: 80px;
        }

        .result-value {
            color: #fff;
            font-weight: bold;
            background-color: #000;
            padding: 5px 10px;
            border-radius: 3px;
            min-width: 70px;
            text-align: right;
        }

        .result-item span {
            color: #adb5bd;
            font-size: 0.9em;
            min-width: 30px;
            text-align: left;
        }

        /* --- Printable Report Styles --- */
        #printable-report-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            z-index: 1000;
        }

        #printable-report {
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 800px;
            margin: 20px auto;
            font-size: 12pt;
        }

        #printable-report h1,
        #printable-report h2,
        #printable-report h3 {
            color: #000;
            text-align: center;
            margin-bottom: 15px;
        }

        #printable-report .report-section {
            margin-bottom: 20px;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        #printable-report .report-section h3 {
            text-align: left;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        #printable-report .report-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }

        #printable-report .report-item:last-child {
            border-bottom: none;
        }

        #printable-report .report-label {
            font-weight: bold;
            flex-basis: 150px;
        }

        #printable-report .report-value {
            flex-grow: 1;
            text-align: right;
        }

        #report-chart-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Print specific styles */
        @media print {

            body>.container,
            body>.menu-button {
                display: none !important;
            }

            #printable-report-container {
                display: block !important;
                position: static !important;
                width: auto !important;
                height: auto !important;
                overflow: visible !important;
                background-color: #fff !important;
                color: #000 !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            #printable-report {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
        }

        /* --- Mobile-first responsive design for screens up to 768px --- */
        @media (max-width: 768px) {
            body {
                align-items: flex-start;
                padding: 5px;
            }

            .container {
                padding: 5px;
            }

            .display-box {
                min-width: auto;
                width: 100%;
                padding: 5px 10px;
            }

            .main-content {
                flex-direction: column;
            }

            .left-controls,
            .right-panel {
                padding: 10px;
                min-height: 0;
            }

            /* Ensure tab content is scrollable and not a fixed height */
            .tab-content-container {
                height: auto;
                min-height: auto;
            }

            .tab-panel {
                padding: 10px;
            }

            .tab-navigation {
                flex-wrap: wrap;
                gap: 5px;
            }

            .tab-button {
                font-size: 0.8em;
                padding: 8px 5px;
            }

            .setting-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .setting-item label {
                flex-basis: auto;
                margin-bottom: 5px;
            }

            .settings-group h3 {
                font-size: 1.1em;
            }

            .results-display {
                gap: 5px;
            }

            .result-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 5px;
            }

            .report-btn {
                font-size: 1em;
                padding: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="container" id="main-app-container">
        <div class="top-panel">
            <div class="display-box">
                <label>Load (N)</label>
                <div id="load-display" class="value-display green-text">0.0</div>
            </div>
            <div class="display-box">
                <label>Speed (mm/min)</label>
                <div id="speed-display" class="value-display">0</div>
            </div>
            <div class="display-box">
                <label>Displacement (mm)</label>
                <div id="displacement-display" class="value-display green-text">0.000</div>
            </div>
        </div>

        <div class="main-content">
            <div class="left-controls">
                <div class="control-buttons-major">
                    <button id="start-button" class="control-button start-btn" title="Start">
                        <svg viewBox="0 0 24 24" fill="white" width="50%" height="50%">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                    </button>
                    <button id="stop-button" class="control-button stop-btn" title="Stop">
                        <svg viewBox="0 0 24 24" fill="white" width="50%" height="50%">
                            <path d="M6 6h12v12H6z" />
                        </svg>
                    </button>
                    <button id="down-button" class="control-button arrow-btn down-arrow" title="Down">
                        <svg viewBox="0 0 24 24" fill="white" width="50%" height="50%">
                            <path d="M7 10l5 5 5-5H7z" />
                        </svg>
                    </button>
                    <button id="up-button" class="control-button arrow-btn up-arrow" title="Up">
                        <svg viewBox="0 0 24 24" fill="white" width="50%" height="50%">
                            <path d="M7 14l5-5 5 5H7z" />
                        </svg>
                    </button>
                </div>
                <div class="graph-area">
                    <div class="graph-header">Load (N) / Displacement (mm)</div>
                    <div>
                        <canvas id="tensile-graph"></canvas>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="connect-ble-container">
                    <button id="connect-ble-btn" class="connect-ble-button">Connect</button>
                </div>

                <div class="tab-navigation">
                    <button class="tab-button" data-target-panel="results-panel">Results</button>
                    <button class="tab-button" data-target-panel="settings-panel">Settings</button>
                    <button class="tab-button" data-target-panel="calibration-panel">Calibration</button>
                </div>

                <div class="tab-content-container">
                    <div id="results-panel" class="tab-panel active">
                        <div class="report-button-container">
                            <button id="report-button" class="report-btn">REPORT</button>
                        </div>

                        <div class="results-display">
                            <div class="result-item">
                                <label>Fmax</label>
                                <div id="fmax-value" class="result-value">0.0</div>
                                <span>N</span>
                            </div>
                            <div class="result-item">
                                <label>Dmax</label>
                                <div id="dmax-value" class="result-value">0.000</div>
                                <span>mm</span>
                            </div>
                            <div class="result-item">
                                <label>Fbreak</label>
                                <div id="fbreak-value" class="result-value">0.0</div>
                                <span>N</span>
                            </div>
                            <div class="result-item">
                                <label>Dbreak</label>
                                <div id="dbreak-value" class="result-value">0.000</div>
                                <span>mm</span>
                            </div>
                            <div class="result-item">
                                <label>Stretch</label>
                                <div id="stretch-value" class="result-value">0.000</div>
                                <span>%</span>
                            </div>
                        </div>
                        <div class="settings-group">
                            <div class="action-buttons">
                                <button id="save-chart-button">Save Chart</button>
                                <button id="load-chart-button">Load Chart</button>
                                <button id="print-on-machine">Print On Machine</button>
                            </div>
                        </div>
                    </div>

                    <div id="settings-panel" class="tab-panel">
                        <div class="settings-group">
                            <h3>Sample Dimensions</h3>
                            <div class="setting-item">
                                <label for="sample-length">Length (mm)</label>
                                <input type="number" id="sample-length" value="100" step="0.1">
                            </div>
                            <div class="setting-item">
                                <label for="sample-width">Width (mm)</label>
                                <input type="number" id="sample-width" value="10" step="0.1">
                            </div>
                            <div class="setting-item">
                                <label for="sample-thickness">Thickness (mm)</label>
                                <input type="number" id="sample-thickness" value="2" step="0.1">
                            </div>
                        </div>

                        <div class="settings-group">
                            <h3>Test Parameters</h3>
                            <div class="setting-item">
                                <label for="test-type">Test Type</label>
                                <select id="test-type">
                                    <option value="0">RCT</option>
                                    <option value="1">ECT</option>
                                    <option value="2">FCT A</option>
                                    <option value="3">FCT B</option>
                                    <option value="4">PAT</option>
                                    <option value="5">TCT</option>
                                    <option value="6">CCT</option>
                                    <option value="7">CMT</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label for="test-speed">Test Speed (mm/min)</label>
                                <input type="number" id="test-speed" value="25" step="1" min="1" max="250">
                            </div>
                            <div class="setting-item">
                                <label for="chart-start-load">Chart Start Load (N)</label>
                                <input type="number" id="chart-start-load" value="0.5" step="0.1" min="0" max="100">
                            </div>
                            <div class="setting-item">
                                <label for="chart-stop-percent">Chart Stop Load (%)</label>
                                <input type="number" id="chart-stop-percent" value="0.0" step="0.1" min="0" max="100">
                            </div>
                            <div class="setting-item">
                                <label for="chart-stop-displacement">Chart Stop Disp. (mm)</label>
                                <input type="number" id="chart-stop-displacement" value="200" step="0.1" min="0"
                                    max="1000">
                            </div>
                            <div class="setting-item">
                                <label for="manual-speed">Manual Speed (mm/min)</label>
                                <input type="number" id="manual-speed" value="250" step="1" min="1" max="250">
                            </div>
                        </div>
                    </div>

                    <div id="calibration-panel" class="tab-panel">
                        <div class="settings-group">
                            <h3>Load Cell Calibration</h3>
                            <div class="setting-item">
                                <label for="lc-capacity">Capacity (Kg)</label>
                                <input type="number" id="lc-capacity" value="50000" step="1">
                            </div>
                            <div class="setting-item">
                                <label for="lc-sensitivity">Sensitivity (mV/V)</label>
                                <input type="number" id="lc-sensitivity" value="2" step="0.001">
                            </div>
                            <div class="setting-item">
                                <label for="user-coef">User Coef</label>
                                <input type="number" id="user-coef" value="1.0000" step="0.0001">
                            </div>
                            <div class="setting-item">
                                <label for="chart-filter">Chart Filter</label>
                                <input type="number" id="chart-filter" value="0" step="1">
                            </div>
                            <div class="setting-item">
                                <label for="disp-filter">Disp Filter</label>
                                <input type="number" id="disp-filter" value="3" step="1">
                            </div>
                            <div class="setting-item">
                                <label for="auto-return-checkbox">Auto Return</label>
                                <input type="checkbox" id="auto-return-checkbox">
                            </div>

                            <div class="action-buttons">
                                <button id="apply-load-calb-button">Apply</button>
                                <button id="save-load-calb-button">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="printable-report-container">
        <div id="printable-report">
            <h1>Crush Test Report</h1>
            <p style="text-align: center; color: #666;" id="report-date-time"></p>

            <div class="report-section">
                <h3>Test Parameters</h3>
                <div class="report-item">
                    <span class="report-label">Sample Length:</span>
                    <span class="report-value" id="report-sample-length"></span>
                </div>
                <div class="report-item">
                    <span class="report-label">Sample Width:</span>
                    <span class="report-value" id="report-sample-width"></span>
                </div>
                <div class="report-item">
                    <span class="report-label">Sample Thickness:</span>
                    <span class="report-value" id="report-sample-thickness"></span>
                </div>
                <div class="report-item">
                    <span class="report-label">Test Type:</span>
                    <span class="report-value" id="report-test-type-param"></span>
                </div>
                <div class="report-item">
                    <span class="report-label">Test Speed:</span>
                    <span class="report-value" id="report-test-speed"></span>
                </div>
            </div>

            <div class="report-section">
                <h3>Test Results</h3>
                <div class="report-item">
                    <span class="report-label">Fmax:</span>
                    <span class="report-value" id="report-fmax-value"></span>
                </div>
                <div class="report-item">
                    <span class="report-label">Dmax:</span>
                    <span class="report-value" id="report-dmax-value"></span>
                </div>
                <div class="report-item">
                    <span class="report-label">Fbreak:</span>
                    <span class="report-value" id="report-fbreak-value"></span>
                </div>
                <div class="report-item">
                    <span class="report-label">Dbreak:</span>
                    <span class="report-value" id="report-dbreak-value"></span>
                </div>
                <div class="report-item">
                    <span class="report-label">Stretch:</span>
                    <span class="report-value" id="report-stretch-value"></span>
                </div>
            </div>

            <div class="report-section">
                <h3>Load vs. Displacement Graph</h3>
                <img id="report-chart-image" alt="Load vs Displacement Graph">
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadDisplay = document.getElementById('load-display');
            const speedDisplay = document.getElementById('speed-display');
            const displacementDisplay = document.getElementById('displacement-display');

            const fmaxValue = document.getElementById('fmax-value');
            const dmaxValue = document.getElementById('dmax-value');
            const fbreakValue = document.getElementById('fbreak-value');
            const dbreakValue = document.getElementById('dbreak-value');
            const stretchValue = document.getElementById('stretch-value');

            const startButton = document.getElementById('start-button');
            const stopButton = document.getElementById('stop-button');
            const downButton = document.getElementById('down-button');
            const upButton = document.getElementById('up-button');
            const reportButton = document.getElementById('report-button');

            // --- Tab Elements ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const resultsPanel = document.getElementById('results-panel');
            const settingsPanel = document.getElementById('settings-panel');
            const calibrationPanel = document.getElementById('calibration-panel');

            // --- Connect BLE Button ---
            const connectBleButton = document.getElementById('connect-ble-btn');

            // --- Settings inputs ---
            const sampleLengthInput = document.getElementById('sample-length');
            const sampleWidthInput = document.getElementById('sample-width');
            const sampleThicknessInput = document.getElementById('sample-thickness');
            const testSpeedInput = document.getElementById('test-speed');
            const testTypeSelect = document.getElementById('test-type');
            const chartStartInput = document.getElementById('chart-start-load');
            const chartStopPercentInput = document.getElementById('chart-stop-percent');
            const chartStopDisplacementInput = document.getElementById('chart-stop-displacement');
            const manualSpeedInput = document.getElementById('manual-speed');


            // --- Calibration inputs ---
            const lcCapacityInput = document.getElementById('lc-capacity');
            const lcSensitivityInput = document.getElementById('lc-sensitivity');
            const userCoefInput = document.getElementById('user-coef');
            const chartFilterInput = document.getElementById('chart-filter');
            const dispFilterInput = document.getElementById('disp-filter');
            const autoReturnInput = document.getElementById('auto-return-checkbox');


            // --- Calibration Buttons ---
            const applyLoadCalbButton = document.getElementById('apply-load-calb-button');
            const saveLoadCalbButton = document.getElementById('save-load-calb-button');

            // --- Chart Data Management Buttons ---
            const saveChartButton = document.getElementById('save-chart-button');
            const loadChartButton = document.getElementById('load-chart-button');
            const printOnMachine = document.getElementById('print-on-machine');


            // --- Printable Report elements ---
            const mainAppContainer = document.getElementById('main-app-container');
            const printableReportContainer = document.getElementById('printable-report-container');
            const reportDateTime = document.getElementById('report-date-time');
            const reportSampleLength = document.getElementById('report-sample-length');
            const reportSampleWidth = document.getElementById('report-sample-width');
            const reportSampleThickness = document.getElementById('report-sample-thickness');
            const reportTestSpeed = document.getElementById('report-test-speed');
            const reportTestTypeParam = document.getElementById('report-test-type-param');

            const reportFmaxValue = document.getElementById('report-fmax-value');
            const reportDmaxValue = document.getElementById('report-dmax-value');
            const reportFbreakValue = document.getElementById('report-fbreak-value');
            const reportDbreakValue = document.getElementById('report-dbreak-value');
            const reportStretchValue = document.getElementById('report-stretch-value');
            const reportChartImage = document.getElementById('report-chart-image');
            const DEVICE_CODE = 0xFFFE;
            const DEVICE_NAME = 'Crush';
            const SERVICE_UUID = "19b10000-e8f2-537e-4f6c-d104768a1214";
            const RX_CHAR_UUID = "19b10001-e8f2-537e-4f6c-d104768a1214";
            const TX_CHAR_UUID = "19b10002-e8f2-537e-4f6c-d104768a1214";
            //----------------------------------------------------------------------------------------------  
            const ctx = document.getElementById('tensile-graph')?.getContext('2d');
            let tensileChart;
            if (ctx) {
                tensileChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Load (N)',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: 'Displacement (mm)',
                                    color: '#ccc'
                                },
                                ticks: {
                                    color: '#ccc',
                                },
                                grid: {
                                    color: '#333'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Load (N)',
                                    color: '#ccc'
                                },
                                ticks: {
                                    color: '#ccc',
                                },
                                grid: {
                                    color: '#333'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            //----------------------------------------------------------------------------------------------  
            const settingArr = new Uint16Array(32);
            let isTestRunning = false;
            let isChartRunning = false;
            let isWebBLEConnected = false;
            let zeroLoadFlag = false;
            let zeroEncFlag = false;
            let loadOffset = 0;
            let encOffset = 0;
            let loadCoef = 1;
            let serialNo = 0;
            let loadDispDig = 0;
            let chartStartDisplacement = 0;
            let loadMax = 0;
            let loadBreak = 0;
            let displacementMax = 0;
            let displacementBreak = 0;
            let bleDevice;
            let txCharacteristic;

            let testParameters = {
                sampleLength: parseFloat(sampleLengthInput.value),
                sampleWidth: parseFloat(sampleWidthInput.value),
                sampleThickness: parseFloat(sampleThicknessInput.value),
                testType: testTypeSelect.value,
                testSpeed: parseInt(testSpeedInput.value),
                chartStartLoad: parseFloat(chartStartInput.value),
                chartStopPercent: parseFloat(chartStopPercentInput.value),
                chartStopDisplacement: parseFloat(chartStopDisplacementInput.value),
                manualSpeed: parseInt(manualSpeedInput.value)
            };

            let calibrationParameters = {
                autoReturnFlag: autoReturnInput.checked ? 1 : 0,
                lcCapacity: parseInt(lcCapacityInput.value),
                lcSensitivity: parseFloat(lcSensitivityInput.value) * 1000,
                userCoef: parseFloat(userCoefInput.value) * 10000,
                chartFilter: parseInt(chartFilterInput.value),
                dispFilter: parseInt(dispFilterInput.value)
            };

            // Update parameters when inputs change
            sampleLengthInput.addEventListener('change', () => testParameters.sampleLength = parseFloat(sampleLengthInput.value));
            sampleWidthInput.addEventListener('change', () => testParameters.sampleWidth = parseFloat(sampleWidthInput.value));
            sampleThicknessInput.addEventListener('change', () => testParameters.sampleThickness = parseFloat(sampleThicknessInput.value));
            testSpeedInput.addEventListener('change', () => testParameters.testSpeed = parseInt(testSpeedInput.value));
            testTypeSelect.addEventListener('change', () => testParameters.testType = testTypeSelect.value);
            chartStartInput.addEventListener('change', () => testParameters.chartStartLoad = parseFloat(chartStartInput.value));
            chartStopPercentInput.addEventListener('change', () => testParameters.chartStopPercent = parseFloat(chartStopPercentInput.value));
            chartStopDisplacementInput.addEventListener('change', () => testParameters.chartStopDisplacement = parseFloat(chartStopDisplacementInput.value));
            manualSpeedInput.addEventListener('change', () => testParameters.manualSpeed = parseInt(manualSpeedInput.value));


            // Update calibration parameters when inputs change
            lcCapacityInput.addEventListener('change', () => calibrationParameters.lcCapacity = parseInt(lcCapacityInput.value));
            lcSensitivityInput.addEventListener('change', () => calibrationParameters.lcSensitivity = parseFloat(lcSensitivityInput.value) * 1000);
            userCoefInput.addEventListener('change', () => calibrationParameters.userCoef = parseFloat(userCoefInput.value) * 10000);
            chartFilterInput.addEventListener('change', () => calibrationParameters.chartFilter = parseInt(chartFilterInput.value));
            dispFilterInput.addEventListener('change', () => calibrationParameters.dispFilter = parseInt(dispFilterInput.value));
            autoReturnInput.addEventListener('change', () => calibrationParameters.autoReturnFlag = autoReturnInput.checked ? 1 : 0);
            //----------------------------------------------------------------------------------------------  
            function showTab(panelId) {
                tabButtons.forEach(button => button.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                const activeButton = document.querySelector(`.tab-button[data-target-panel="${panelId}"]`);
                if (activeButton) activeButton.classList.add('active');
                const targetPanel = document.getElementById(panelId);
                if (targetPanel) targetPanel.classList.add('active');
            }
            //----------------------------------------------------------------------------------------------  
            tabButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    showTab(event.target.dataset.targetPanel);
                });
            });
            showTab('results-panel');
            //----------------------------------------------------------------------------------------------  
            async function connectToBleDevice() {
                try {
                    console.log('Requesting Bluetooth Device...');
                    bleDevice = await navigator.bluetooth.requestDevice({
                        filters: [{ name: DEVICE_NAME }],
                        optionalServices: [SERVICE_UUID]
                    });

                    console.log('Connecting to GATT Server...');
                    const server = await bleDevice.gatt.connect();

                    console.log('Getting Service...');
                    const service = await server.getPrimaryService(SERVICE_UUID);

                    console.log('Getting RX Characteristic (for receiving data)...');
                    const rxCharacteristic = await service.getCharacteristic(RX_CHAR_UUID);
                    rxCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                    await rxCharacteristic.startNotifications();

                    console.log('Getting TX Characteristic (for sending data)...');
                    txCharacteristic = await service.getCharacteristic(TX_CHAR_UUID);

                    console.log('✅ Connected!');
                    bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                    isWebBLEConnected = true;
                    updateConnectButtonUI();
                    sendCMD(0xFE);
                } catch (error) {
                    console.error('Connection failed!', error);
                    isWebBLEConnected = false;
                    updateConnectButtonUI();
                }
            }
            //----------------------------------------------------------------------------------------------  
            function initSetting() {
                calibrationParameters.autoReturnFlag = settingArr[0];
                autoReturnInput.checked = (calibrationParameters.autoReturnFlag === 0) ? false : true;
                calibrationParameters.lcCapacity = settingArr[1];
                lcCapacityInput.value = calibrationParameters.lcCapacity;
                calibrationParameters.lcSensitivity = settingArr[2];
                lcSensitivityInput.value = (calibrationParameters.lcSensitivity * 0.001).toFixed(3);
                calibrationParameters.userCoef = settingArr[3];
                userCoefInput.value = (calibrationParameters.userCoef * 0.0001).toFixed(4);
                calibrationParameters.chartFilter = settingArr[4];
                chartFilterInput.value = calibrationParameters.chartFilter;
                calibrationParameters.dispFilter = settingArr[5];
                dispFilterInput.value = calibrationParameters.dispFilter;
                applyLoadCalibration();
            }
            //----------------------------------------------------------------------------------------------  
            function handleNotifications(event) {
                let load = 0;
                let displacement = 0;
                let loadSumCntr = 0;
                let loadSum = 0;
                let chartDisplacement = 0;

                const value = event.target.value;
                const dataView = new DataView(value.buffer);
                if (dataView.byteLength == 68) {
                    const devCode = dataView.getUint16(66, true);
                    if (devCode == DEVICE_CODE) {
                        //speedDisplay.textContent = dataView.byteLength;
                        serialNo = dataView.getUint16(64, true);
                        for (let i = 0; i < 32; i++) {
                            settingArr[i] = dataView.getUint16(i * 2, true);
                        }
                        initSetting();
                    }
                } else if (dataView.byteLength >= 9) {
                    const rawFlags = dataView.getUint16(0, true);
                    const rawSpeed = dataView.getUint16(2, true);
                    //---------------- Buffer Loop --------------------------
                    for (let i = 4; (i + 8) <= dataView.byteLength; i += 8) {
                        const rawLoad = dataView.getInt32(i, true);
                        const rawEncoder = dataView.getInt32(i + 4, true);
                        if (zeroLoadFlag) {
                            loadOffset = rawLoad;
                            zeroLoadFlag = false;
                        }
                        if (zeroEncFlag) {
                            encOffset = rawEncoder;
                            zeroEncFlag = false;
                        }

                        load = (rawLoad - loadOffset) * loadCoef;
                        displacement = (rawEncoder - encOffset) * 0.000625;
                        loadSumCntr += 1;
                        loadSum += load;

                        if (isTestRunning) {
                            if (isChartRunning) {
                                chartDisplacement = displacement - chartStartDisplacement;
                                if (tensileChart) {
                                    tensileChart.data.labels.push(chartDisplacement.toFixed(3));
                                    tensileChart.data.datasets[0].data.push(load);
                                }

                                if (load > loadMax) {
                                    loadMax = load;
                                    displacementMax = chartDisplacement;
                                }

                                let autoStopLoadThreshold = -100.0;
                                if ((loadMax * 1000) > calibrationParameters.lcCapacity) {
                                    autoStopLoadThreshold = (testParameters.chartStopPercent * loadMax) - (load * 100);
                                }

                                if (displacement >= testParameters.chartStopDisplacement || autoStopLoadThreshold > 0.0) {
                                    stopTest();
                                }
                                else {
                                    loadBreak = load;
                                    displacementBreak = chartDisplacement;
                                }
                            } else {
                                if (load > testParameters.chartStartLoad) {
                                    isChartRunning = true;
                                    chartStartDisplacement = displacement;
                                    loadMax = 0;
                                    loadBreak = 0;
                                    displacementMax = 0;
                                    displacementBreak = 0;
                                }
                                else {
                                    if (displacement >= testParameters.chartStopDisplacement) {
                                        stopTest();
                                    }
                                }
                            }
                        }
                    }
                    //---------------- End Buffer Loop -----------------------
                    //---------------- Display summery -----------------------
                    if (loadSumCntr > 0) {
                        load = loadSum / loadSumCntr;
                        loadDisplay.textContent = load.toFixed(loadDispDig);
                        displacementDisplay.textContent = displacement.toFixed(3);
                        speedDisplay.textContent = rawSpeed;
                        if (isTestRunning && tensileChart) {
                            tensileChart.update('none');
                        }
                    }
                }
                //speedDisplay.textContent = dataView.byteLength;
                //sendCMD(0x80);
            }
            //----------------------------------------------------------------------------------------------  
            async function sendSpeed(speed) {
                if (!isWebBLEConnected || !txCharacteristic) {
                    console.error("Not connected or TX Characteristic not available.");
                    return;
                }
                const buffer = new ArrayBuffer(4);
                const view = new DataView(buffer);
                view.setUint8(0, 0x20); //speed register address
                view.setInt16(1, speed, true);//speed value
                view.setUint8(3, 0x81);//beep

                try {
                    await txCharacteristic.writeValueWithoutResponse(buffer);
                    console.log(`Sent speed command: ${speed}`);
                } catch (error) {
                    console.error("Failed to send command:", error);
                }
            }
            //----------------------------------------------------------------------------------------------  
            async function sendSetting(address, value) {
                if (!isWebBLEConnected || !txCharacteristic) {
                    console.error("Not connected");
                    return;
                }
                const buffer = new ArrayBuffer(3);
                const view = new DataView(buffer);
                view.setUint8(0, address); //register address
                view.setInt16(1, value, true);//speed value
                try {
                    await txCharacteristic.writeValueWithoutResponse(buffer);
                    console.log(`Sent speed command: ${value}`);
                } catch (error) {
                    console.error("Failed to send command:", error);
                }
            }
            //----------------------------------------------------------------------------------------------  
            async function sendCMD(cmd) {
                if (!isWebBLEConnected || !txCharacteristic) {
                    console.error("Not connected or TX Characteristic not available.");
                    return;
                }
                const buffer = new Uint8Array(1);
                buffer[0] = cmd;
                try {
                    await txCharacteristic.writeValueWithoutResponse(buffer);
                    console.log(`Sent command: ${cmd}`);
                } catch (error) {
                    console.error("Failed to send command:", error);
                }
            }
            //----------------------------------------------------------------------------------------------  
            async function sendPrint() {
                if (!isWebBLEConnected || !txCharacteristic) {
                    console.error("Not connected or TX Characteristic not available.");
                    return;
                }

                // 1. Create a 321-byte ArrayBuffer
                const buffer = new ArrayBuffer(500);

                // 2. Create a Uint8Array view to access and modify the buffer's bytes
                const view = new Uint8Array(buffer);
                const encoder = new TextEncoder();

                // 3. Set the first byte to 0xff
                view[0] = 0xff;
                //Code page = 0
                view[1] = 0x1b;
                view[2] = 0x74;
                view[3] = 0x00;
                //font = 1
                view[4] = 0x1d;
                view[5] = 0x21;
                view[6] = 0x01;
                // Title Text
                //const 
                let myText = "CRUSH TEST REPORT";
                const padSize = Math.floor((32 - myText.length) / 2);
                myText = myText.padStart(32 - padSize, " ");
                myText = myText.padEnd(32, " ");
                let encodedText = encoder.encode(myText);
                // 5. Copy the encoded text bytes into the view, starting from the second byte (offset 1)
                // The set() method efficiently copies the data.
                view.set(encodedText, 7);
                //font = 0
                view[39] = 0x1d;
                view[40] = 0x21;
                view[41] = 0x00;
                //
                myText = 'your_320_character_long_string_goes_here'.padEnd(454, '.');
                encodedText = encoder.encode(myText);
                view.set(encodedText, 42);
                //
                view[496] = 0x0A;
                view[497] = 0x0A;
                view[498] = 0x0A;
                view[499] = 0x0A;


                try {
                    await txCharacteristic.writeValueWithoutResponse(buffer);
                    console.log(`Sent command: Print`);
                } catch (error) {
                    console.error("Failed to send command:", error);
                }
            }
            //----------------------------------------------------------------------------------------------  
            async function saveSetting() {
                if (!isWebBLEConnected || !txCharacteristic) {
                    console.error("Not connected or TX Characteristic not available.");
                    return;
                }

                const tempBuff = new Uint8Array(96);
                const view = new DataView(tempBuff.buffer);
                let idx = 0;
                let arrIndex = 0;
                //
                if (calibrationParameters.autoReturnFlag !== settingArr[arrIndex]) {
                    settingArr[arrIndex] = calibrationParameters.autoReturnFlag;
                    tempBuff[idx] = arrIndex;
                    view.setUint16(idx + 1, settingArr[arrIndex], true);
                    idx += 3;
                }
                arrIndex++;
                if (calibrationParameters.lcCapacity !== settingArr[arrIndex]) {
                    settingArr[arrIndex] = calibrationParameters.lcCapacity;
                    tempBuff[idx] = arrIndex;
                    view.setUint16(idx + 1, settingArr[arrIndex], true);
                    idx += 3;
                }
                arrIndex++;
                if (calibrationParameters.lcSensitivity !== settingArr[arrIndex]) {
                    settingArr[arrIndex] = calibrationParameters.lcSensitivity;
                    tempBuff[idx] = arrIndex;
                    view.setUint16(idx + 1, settingArr[arrIndex], true);
                    idx += 3;
                }
                //
                if (idx > 0) {
                    tempBuff[idx] = 0x81;//beep
                    idx++;
                    const buff = tempBuff.subarray(0, idx);
                    try {
                        await txCharacteristic.writeValueWithoutResponse(buff);
                        console.log(`Sent command: ${buff}`);
                    } catch (error) {
                        console.error("Failed to send command:", error);
                    }
                }

                //sendCMD(0xFD);  //save setting
            }
            //----------------------------------------------------------------------------------------------  
            function onDisconnected() {
                console.log('Device disconnected.');
                isWebBLEConnected = false;
                txCharacteristic = null;
                updateConnectButtonUI();
            }
            //----------------------------------------------------------------------------------------------  
            function disconnectFromBleDevice() {
                if (isTestRunning) {
                    stopTest();
                }
                if (bleDevice && bleDevice.gatt.connected) {
                    bleDevice.gatt.disconnect();
                }
            }
            //----------------------------------------------------------------------------------------------  
            function updateConnectButtonUI() {
                if (isWebBLEConnected) {
                    connectBleButton.textContent = 'Disconnect';
                    connectBleButton.classList.add('disconnect');
                } else {
                    connectBleButton.textContent = 'Connect';
                    connectBleButton.classList.remove('disconnect');
                }
            }
            //----------------------------------------------------------------------------------------------  
            startButton.addEventListener('click', () => {
                if (!isWebBLEConnected) {
                    alert("Please connect to the BLE device first.");
                    return;
                }
                if (isTestRunning) return;
                isTestRunning = true;
                console.log('Test Started');
                /*
                fmaxValue.textContent = '0.0';
                dmaxValue.textContent = '0.000';
                fbreakValue.textContent = '0.0';
                dbreakValue.textContent = '0.000';
                stretchValue.textContent = '0.000';
                */
                if (tensileChart) {
                    tensileChart.data.labels = [];
                    tensileChart.data.datasets[0].data = [];
                    tensileChart.update();
                }
                sendSpeed(testParameters.testSpeed);
            });
            //----------------------------------------------------------------------------------------------  
            function stopTest() {

                if (!isTestRunning) {
                    sendSpeed(0);
                    return;
                }
                isTestRunning = false;
                isChartRunning = false;
                console.log('Test Stopped');

                if (calibrationParameters.autoReturnFlag !== 0) {
                    sendSpeed(-32768);
                } else {
                    sendSpeed(0);
                }

                fmaxValue.textContent = loadMax.toFixed(loadDispDig);
                dmaxValue.textContent = displacementMax.toFixed(3);
                fbreakValue.textContent = loadBreak.toFixed(loadDispDig);
                dbreakValue.textContent = displacementBreak.toFixed(3);
                if (testParameters.sampleLength > 0) {
                    stretchValue.textContent = ((displacementBreak / testParameters.sampleLength) * 100).toFixed(3);
                }
            }
            //----------------------------------------------------------------------------------------------  
            function applyLoadCalibration() {
                if (calibrationParameters.lcSensitivity === 0) return;
                loadCoef = (calibrationParameters.userCoef * calibrationParameters.lcCapacity * 0.00001461304728) / (calibrationParameters.lcSensitivity);
                if (calibrationParameters.lcCapacity == 1) {
                    loadDispDig = 3;
                } else if (calibrationParameters.lcCapacity <= 10) {
                    loadDispDig = 2;
                } else if (calibrationParameters.lcCapacity <= 100) {
                    loadDispDig = 1;
                } else if (calibrationParameters.lcCapacity <= 1000) {
                    loadDispDig = 0;
                } else if (calibrationParameters.lcCapacity <= 10000) {
                    loadDispDig = 3;
                }
            }
            //----------------------------------------------------------------------------------------------  
            stopButton.addEventListener('click', stopTest);
            //----------------------------------------------------------------------------------------------  
            applyLoadCalbButton.addEventListener('click', () => {
                applyLoadCalibration();
            });
            //----------------------------------------------------------------------------------------------  
            saveLoadCalbButton.addEventListener('click', () => {
                saveSetting();
            });
            //----------------------------------------------------------------------------------------------  
            downButton.addEventListener('mousedown', () => {
                if (isTestRunning || !isWebBLEConnected) return;
                sendSpeed(-testParameters.manualSpeed);
            });

            downButton.addEventListener('mouseup', () => {
                if (!isWebBLEConnected) return;
                sendSpeed(0);
            });

            upButton.addEventListener('mousedown', () => {
                if (isTestRunning || !isWebBLEConnected) return;
                sendSpeed(testParameters.manualSpeed);
            });

            upButton.addEventListener('mouseup', () => {
                if (!isWebBLEConnected) return;
                sendSpeed(0);
            });
            //----------------------------------------------------------------------------------------------  
            downButton.addEventListener('touchstart', () => {
                if (isTestRunning || !isWebBLEConnected) return;
                sendSpeed(-testParameters.manualSpeed);
            });

            downButton.addEventListener('touchend', () => {
                if (!isWebBLEConnected) return;
                sendSpeed(0);
            });

            upButton.addEventListener('touchstart', () => {
                if (isTestRunning || !isWebBLEConnected) return;
                sendSpeed(testParameters.manualSpeed);
            });

            upButton.addEventListener('touchend', () => {
                if (!isWebBLEConnected) return;
                sendSpeed(0);
            });
            //----------------------------------------------------------------------------------------------   
            function getSelectedTestTypeText() {
                const selectedOption = testTypeSelect.options[testParameters.testType];
                // Return the text content of the selected option
                if (selectedOption) {
                    return selectedOption.textContent;
                }
                return '';
            }
            //----------------------------------------------------------------------------------------------        
            reportButton.addEventListener('click', () => {
                reportDateTime.textContent = new Date().toLocaleString();
                reportSampleLength.textContent = `${testParameters.sampleLength} mm`;
                reportSampleWidth.textContent = `${testParameters.sampleWidth} mm`;
                reportSampleThickness.textContent = `${testParameters.sampleThickness} mm`;
                reportTestSpeed.textContent = `${testParameters.testSpeed} mm/min`;
                reportTestTypeParam.textContent = getSelectedTestTypeText();

                reportFmaxValue.textContent = `${fmaxValue.textContent} N`;
                reportDmaxValue.textContent = `${dmaxValue.textContent} mm`;
                reportFbreakValue.textContent = `${fbreakValue.textContent} N`;
                reportDbreakValue.textContent = `${dbreakValue.textContent} mm`;
                reportStretchValue.textContent = `${stretchValue.textContent} %`;

                if (tensileChart) {
                    const originalWidth = tensileChart.canvas.width;
                    const originalHeight = tensileChart.canvas.height;
                    tensileChart.resize(800, 400);
                    reportChartImage.src = tensileChart.toBase64Image();
                    tensileChart.resize(originalWidth, originalHeight);
                } else {
                    reportChartImage.src = '';
                }

                mainAppContainer.style.display = 'none';
                printableReportContainer.style.display = 'block';

                window.print();

                const afterPrint = () => {
                    printableReportContainer.style.display = 'none';
                    mainAppContainer.style.display = 'flex';
                    window.removeEventListener('afterprint', afterPrint);
                };
                window.addEventListener('afterprint', afterPrint);
            });
            //----------------------------------------------------------------------------------------------
            saveChartButton.addEventListener('click', () => {
                if (tensileChart && tensileChart.data.labels.length > 0) {
                    const chartDataToSave = {
                        labels: tensileChart.data.labels,
                        data: tensileChart.data.datasets[0].data
                    };
                    localStorage.setItem('savedCrushChartData', JSON.stringify(chartDataToSave));
                    alert('Chart data saved successfully!');
                } else {
                    alert('No chart data to save.');
                }
            });
            //----------------------------------------------------------------------------------------------
            loadChartButton.addEventListener('click', () => {
                const savedData = localStorage.getItem('savedCrushChartData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (tensileChart) {
                        tensileChart.data.labels = parsedData.labels;
                        tensileChart.data.datasets[0].data = parsedData.data;
                        tensileChart.update();
                        alert('Chart data loaded successfully!');
                    }
                } else {
                    alert('No saved chart data found.');
                }
            });
            //----------------------------------------------------------------------------------------------
            printOnMachine.addEventListener('click', () => {
                if (tensileChart && tensileChart.data.labels.length > 0) {
                    sendPrint();
                    //alert('print successfully!');
                } else {
                    alert('No data to print.');
                }
            });
            //----------------------------------------------------------------------------------------------
            connectBleButton.addEventListener('click', async () => {
                if (isWebBLEConnected) {
                    disconnectFromBleDevice();
                } else {
                    await connectToBleDevice();
                }
            });
            //----------------------------------------------------------------------------------------------
            updateConnectButtonUI();
        });
    </script>
</body>

</html>
